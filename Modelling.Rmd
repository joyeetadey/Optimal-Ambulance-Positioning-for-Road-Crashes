---
title: "Clustering"
author: "Joyeeta Dey"
date: "22/11/2021"
output: html_document
---

## installing packages
```{r}
library("viridisLite")
library("GGally")
library("tidyverse")
library("dplyr")
library("RColorBrewer")
library("timeDate")
library("leaflet")
library("timeDate")
library("solrad")
library("RColorBrewer")
library("lattice")
library("ggcorrplot")
library("FSelector")
library(ggplot2)
```

### reading datasets
```{r}
segment_geo_df <- read.table("C:/Users/Joyeeta/Desktop/sem 5/DA project/Datasets/segments_geometry.csv",header=TRUE,sep=",")

roads <- read.table("C:/Users/Joyeeta/Desktop/sem 5/DA project/Datasets/segment.csv",header=TRUE,sep=",")

acdnt <- read.table("C:/Users/Joyeeta/Desktop/sem 5/DA project/Datasets/accidents2.csv",header=TRUE,sep=",")


df <- read.table("C:/Users/Joyeeta/Desktop/sem 5/DA project/Datasets/final.csv",header=TRUE,sep=",")

```

## Color Palette
```{r}
pal <- brewer.pal(n = 8, name = "Set2")
pal
```

## Checking relation among the variables - Information Gain
```{r}
library(factoextra)
library(NbClust)

head(df,5)

df <- na.omit(df)
## according to information gain
df <- df[-c(1)]
weights <- gain.ratio(class~., df)
print(weights)

attr <- colnames(df)
attr <- attr[-c(22)]
attr

wt <- cbind(attr,weights)
head(wt)


## plotting the significance of variables
ggplot(wt, aes(x=factor(attr), y=attr_importance)) +
  geom_bar(position=position_dodge(), stat="identity",  colour="black", fill="#E78AC3", width = 1)+
theme(axis.text.x = element_text(angle=90, vjust=0.6))


## inference: based on the analysis: day, distance_from_the_centre, elevation, latitude, longitude, precipitation, relative_humidity, specific_humidity, temperature, wind_u, wind_v has significance importance


## making df with the selected variables

head(df,3)

selected_df <- df[c(3,4,8,13,14,17,18,19,20,21,22)]
head(selected_df)


unique(df$population_density)

```

```{r}

## selecting only accidents dataset

acc_df <- selected_df %>%
  filter(class==1)
head(acc_df)

acc_df <- acc_df[-c(11)]
sum(is.na(acc_df$specific_humidity))

acc_df <- na.omit(acc_df)
head(acc_df)
```

## using elbow method
```{r}
fviz_nbclust(acc_df, kmeans, method = "wss") +
  geom_vline(xintercept = 3, linetype = 3)+
  labs(subtitle = "Elbow method")
```

### Silhouette method
```{r}

fviz_nbclust(acc_df, kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")
```

# Clustering for k = 2,3,5,7
```{r}
k2 <- kmeans(acc_df, centers = 3, nstart = 25)
k3 <- kmeans(acc_df, centers = 4, nstart = 25)
k4 <- kmeans(acc_df, centers = 5, nstart = 25)
k5 <- kmeans(acc_df, centers = 7, nstart = 25)

pal <- brewer.pal(n = 8, name = "Set2")
pal

# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = acc_df) + ggtitle("k = 3")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)  
p2 <- fviz_cluster(k3, geom = "point",  data = acc_df) + ggtitle("k = 4")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)  
p3 <- fviz_cluster(k4, geom = "point",  data = acc_df) + ggtitle("k = 5")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)  
p4 <- fviz_cluster(k5, geom = "point",  data = acc_df) + ggtitle("k = 7")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```
## for k2
```{r}
## analysis

k2$size
k2$totss
k2$withinss
k2$tot.withinss
```

## for k3
```{r}

k3$size
k3$totss
k3$withinss
k3$tot.withinss
```


## for k4
```{r}

k4$size
k4$totss
k4$withinss
k4$tot.withinss
```


## for k5
```{r}

k5$size
k5$totss
k5$withinss
k5$tot.withinss
```

## Inference: k=7 has the least tot.withinss

# Cluster analysis
```{r}
scaled_data <- acc_df
set.seed(20)
clusters <- kmeans(scaled_data, 5)

cluster_table <- table(clusters$cluster)
cluster_table

df <- acdnt[,-c(1,2,3)]
cluster_df <- aggregate(acc_df, by=list(cluster=clusters$cluster), mean)
cluster_df


dd <- cbind(acc_df, cluster=clusters$cluster)
head(dd)

head(clusters$cluster, 4)

clusters$size

center <- as.data.frame(clusters$centers)
center

```

## visualization of variables dependency on cluster
```{r}
ggplot(dd, aes(x = latitude	, y = longitude, color=as.factor(cluster), shape=as.factor(cluster))) +
  geom_point() + 
  scale_color_manual(values=pal)+
  theme(legend.position="top")

ggplot(dd, aes(x = distance_from_centre, y = longitude, color=as.factor(cluster), shape=as.factor(cluster))) +
  geom_point() + 
  scale_color_manual(values=pal)+
  theme(legend.position="top")


ggplot(dd, aes(x = distance_from_centre, y = latitude, color=as.factor(cluster), shape=as.factor(cluster))) +
  geom_point() + 
  scale_color_manual(values=pal)+
  theme(legend.position="top")


ggplot(dd, aes(x = distance_from_centre, y = elevation, color=as.factor(cluster), shape=as.factor(cluster))) +
  geom_point() + 
  scale_color_manual(values=pal)+
  theme(legend.position="top")


```
```{r}

fviz_cluster(k5, data = dd)+ ggtitle("k = 7")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)

amb_pts <- acc_df %>%
  mutate(cluster = k5$cluster) 

head(amb_pts,3)


amb_loc <- as.data.frame(k5$centers)
amb_loc


#plotting the points

ggplot() +
  geom_point(data = amb_pts, mapping = aes(x = latitude	, y = longitude, color=as.factor(cluster), shape=as.factor(cluster))) + 
  geom_point(data = amb_loc, mapping = aes(x = latitude	, y = longitude))+
  scale_color_manual(values=pal)+
  theme(legend.position="top")

```



## dependency of other factors on the clusters
```{r}
## dependency of cluster on week day
ggplot(dd, aes(x = relative_humidity)) +geom_histogram(fill="#A6D854") +
  theme(legend.position="top")+facet_wrap(dd$cluster)

## dependency of cluster on month
ggplot(dd, aes(x = temp)) +geom_histogram(fill="#FC8D62") +
  theme(legend.position="top")+facet_wrap(dd$cluster)


## dependency of cluster on hour
ggplot(dd, aes(x = specific_humidity)) +geom_histogram(fill="#66C2A5") +
  theme(legend.position="top")+facet_wrap(dd$cluster)


## dependency of cluster on latitude and longitude
ggplot(dd, aes(x = latitude,y=longitude, color=as.factor(cluster))) +geom_point() + 
  scale_color_manual(values=pal)+
  theme(legend.position="top")+facet_wrap(dd$cluster)


## dependency of cluster on latitude and longitude
ggplot(dd, aes(x = elevation)) +geom_histogram(fill="#E78AC3")+theme(legend.position="top")+facet_wrap(dd$cluster)

```  

## considering other parameters
```{r}
library(patchwork)

head
acc_df2 <- acc_df[c(1,2)]
head(acc_df2,3)

```

# Clustering for k = 3,4,5,7
```{r}
k2 <- kmeans(acc_df2, centers = 3, nstart = 25)
k3 <- kmeans(acc_df2, centers = 4, nstart = 25)
k4 <- kmeans(acc_df2, centers = 5, nstart = 25)
k5 <- kmeans(acc_df2, centers = 7, nstart = 25)

pal <- brewer.pal(n = 8, name = "Set2")
pal

# plots to compare
p1 <- fviz_cluster(k2, geom = "point", data = acc_df2) + ggtitle("k = 3")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)  
p2 <- fviz_cluster(k3, geom = "point",  data = acc_df2) + ggtitle("k = 4")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)  
p3 <- fviz_cluster(k4, geom = "point",  data = acc_df2) + ggtitle("k = 5")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)  
p4 <- fviz_cluster(k5, geom = "point",  data = acc_df2) + ggtitle("k = 7")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)

library(gridExtra)
grid.arrange(p1, p2, p3, p4, nrow = 2)

```


```{r}

scaled_data <- acc_df2
set.seed(20)
clusters <- kmeans(scaled_data, 5)

cluster_table <- table(clusters$cluster)
cluster_table

df <- acdnt[,-c(1,2,3)]
cluster_df <- aggregate(acc_df2, by=list(cluster=clusters$cluster), mean)
cluster_df


dd <- cbind(acc_df2, cluster=clusters$cluster)
head(dd)


ggplot(dd, aes(x = latitude	, y = longitude, color=as.factor(cluster), shape=as.factor(cluster))) +
  geom_point() + 
  scale_color_manual(values=pal)+
  theme(legend.position="top")
```


## Elbow method
```{r}
library(tidyverse)  # data manipulation
library(cluster)    # clustering algorithms
library(factoextra) # clustering algorithms & visualization


set.seed(123)

fviz_nbclust(acc_df2, kmeans, method = "wss")
```

## Silhouette method
```{r}

fviz_nbclust(acc_df2, kmeans, method = "silhouette")
```


## final cluster
```{r}
set.seed(123)
final <- kmeans(acc_df2, 7, nstart = 25)

final$totss
final$withinss
final$tot.withinss
final$size
```


```{r}

fviz_cluster(final, data = acc_df2)+ ggtitle("k = 7")+scale_fill_manual(values = pal)+scale_color_manual(values=pal)

amb_pts <- acc_df2 %>%
  mutate(cluster = final$cluster) 

head(amb_pts,3)


amb_loc <- as.data.frame(final$centers)
amb_loc
```

```{r}

#plotting the points

ggplot() +
  geom_point(data = amb_pts, mapping = aes(x = latitude	, y = longitude, color=as.factor(cluster), shape=as.factor(cluster))) + 
  geom_point(data = amb_loc, mapping = aes(x = latitude	, y = longitude))+
  scale_color_manual(values=pal)+
  theme(legend.position="top")

```

## map for k=4 for model2
```{r}

col <- colorFactor(c("#66C2A5", "#FC8D62", "#8DA0CB", "#E78AC3" ,"#A6D854", "#FFD92F"), domain = c(1,2,3,4,5,6,7))

leaflet(amb_pts) %>% addTiles() %>%
  addCircleMarkers(
    color = ~col(cluster),
    radius=5,
    stroke = FALSE, fillOpacity = 0.6
  )
```


# Decision Trees for prediction of accident

```{r}
library(rpart)
library(rpart.plot)
library(caret)

## splitting in training and testing
train_samples <- selected_df$class %>%
  createDataPartition(p=0.8,list=FALSE)
head(train_samples)

train <-  selected_df[train_samples,]
test <-  selected_df[-train_samples,]

fit <- rpart(class~., data = train, method = 'class')
rpart.plot(fit, box.palette=pal)


## removing distance_from_centre

head(selected_df,3)

pred <-predict(fit, test, type = 'class')
 
# Confusion Matrix
cm <- table(test$class, pred)
cm
 
# Model Evaluation
confusionMatrix(cm)
```

## Removing the major variable
```{r}

selected_df2 <- selected_df[-c(4)]


train_samples <- selected_df2$class %>%
  createDataPartition(p=0.8,list=FALSE)
head(train_samples)

train <-  selected_df2[train_samples,]
test <-  selected_df2[-train_samples,]

fit <- rpart(class~., data = train, method = 'class')
rpart.plot(fit, box.palette=pal)


pred <-predict(fit, test, type = 'class')
 
# Confusion Matrix
cm <- table(test$class, pred)
cm
 
# Model Evaluation
confusionMatrix(cm)

```

## checking the contribution of weather on accidents
```{r}

selected_df3 <- selected_df[-c(1,2,3,4,5)]

train_samples <- selected_df3$class %>%
  createDataPartition(p=0.8,list=FALSE)
head(train_samples)

train <-  selected_df3[train_samples,]
test <-  selected_df3[-train_samples,]

fit <- rpart(class~., data = train, method = 'class')
rpart.plot(fit, box.palette=pal)


pred <-predict(fit, test, type = 'class')
 
# Confusion Matrix
cm <- table(test$class, pred)
cm
 
# Model Evaluation
confusionMatrix(cm)



```
# Naive Bayes Classifier

```{r}

library(e1071)
library(caTools)
library(caret)


## splitting in training and testing
train_samples <- selected_df$class %>%
  createDataPartition(p=0.8,list=FALSE)
head(train_samples)

train <-  selected_df[train_samples,]
test <-  selected_df[-train_samples,]


set.seed(120)  # Setting Seed
classifier_cl <- naiveBayes(class ~ ., data = train)
classifier_cl


y_pred <- predict(classifier_cl, newdata = test)
 
# Confusion Matrix
cm <- table(test$class, y_pred)
cm
 
# Model Evaluation
confusionMatrix(cm)
```


```{r}

selected_df2 <- selected_df[-c(4)]


train_samples <- selected_df2$class %>%
  createDataPartition(p=0.8,list=FALSE)
head(train_samples)

train <-  selected_df2[train_samples,]
test <-  selected_df2[-train_samples,]

set.seed(120)  # Setting Seed
classifier_cl <- naiveBayes(class ~ ., data = train)
classifier_cl


y_pred <- predict(classifier_cl, newdata = test)
 
# Confusion Matrix
cm <- table(test$class, y_pred)
cm
 
# Model Evaluation
confusionMatrix(cm)
```

```{r}

selected_df3 <- selected_df[-c(1,2,3,4,5)]

train_samples <- selected_df3$class %>%
  createDataPartition(p=0.8,list=FALSE)
head(train_samples)

train <-  selected_df3[train_samples,]
test <-  selected_df3[-train_samples,]

set.seed(120)  # Setting Seed
classifier_cl <- naiveBayes(class ~ ., data = train)
classifier_cl


y_pred <- predict(classifier_cl, newdata = test)
 
# Confusion Matrix
cm <- table(test$class, y_pred)
cm
 
# Model Evaluation
confusionMatrix(cm)
```




